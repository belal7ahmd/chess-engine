<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Chess Board</title>
    <!--for Styling-->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <!-- 2. jQuery (Requirement) -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- 3. The chessboard.js library -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
</head>
<body>
    <div id="board-container">
        <div style="background-color: black;">
            <span style="background-color: white;" id="eval"></span>
        </div>
        <div id="myBoard" style="width: 400px"></div>
        <div class="selectors">
            <select onchange="onChangeSelector('black')" id="player-black" class="selector">
                <option value="Player">Player</option>
                <option value="Computer">Computer</option>
            </select>
            <select onchange="onChangeSelector('white')" id="player-white" class="selector">
                <option value="Player">Player</option>
                <option value="Computer">Computer</option>
            </select>
        </div>
        <div class="selectors">
            <h6 id="depthTitle">Depth: 6</h6>
            <input type="range" id="depth-slider" min="1" max="10" value="6" onchange="onDepthChange(this)">
        </div>
    </div>
    
    <label>Status:</label>
    <div id="status" style="display: block"></div>
    <label>FEN:</label>
    <div id="fen"></div>
    <label>PGN:</label>
    <div id="pgn"></div>

    <textarea id="fenEnter"></textarea>
    <textarea id="pgnEnter"></textarea>

    <button type="button" onclick="changeBoard()" id="change-board">Change Board</button>

    <style>
        #board-container {
            display: flex;
            align-items: center;
        }
        #eval-bar {
            width: 20px;
            height: 400px;
            border: 1px solid black;
            margin-right: 10px;
            background: linear-gradient(to top, black 50%, white 50%);
        }
        .selectors {
            margin-left: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .selector {
            margin-bottom: 50px;
            margin-top: 50px;

        }
    </style>

    <script>
        let board = null
        let game = new Chess()

        let $status = $('#status')
        let $fen = $('#fen')
        let $pgn = $('#pgn')

        let $depthSlider = $('#depth-slider')
        let $evalBar = $('#eval')

        let $fenEnter = $('#fenEnter')
        let $pgnEnter = $('#pgnEnter')

        let depth = 6

        let whiteSquareGrey = '#a9a9a9'
        let blackSquareGrey = '#696969'


    
        function changeBoard() {
            if ($fenEnter.val() !== ""){
                game.load($fenEnter.val())
                board.position(game.fen())
            } else if ($pgnEnter.val() !== "") {
                game.load_pgn($pgnEnter.val())
                board.position(game.fen())
            }

        }

        function removeGreySquares () {
            $('#myBoard .square-55d63').css('background', '')
        }

        function greySquare (square) {
            let $square = $('#myBoard .square-' + square)

            let background = whiteSquareGrey
            if ($square.hasClass('black-3c85d')) {
                background = blackSquareGrey
            }

            $square.css('background', background)
        }

        function onDragStart (source, piece) {
            // do not pick up pieces if the game is over
            if (game.game_over()) return false

            // or if it's not that side's turn
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false
            }

            if (piece.search(/^b/) !== -1 && $('#player-black').val() === "Computer"
                || piece.search(/^w/) !== -1 && $('#player-white').val() === "Computer") {
                return false
            }
        }

        function onDrop (source, target) {
                removeGreySquares()

                let promotion = 'q' // NOTE: always promote to a queen for example simplicity

                if (game.turn() == 'w' && target[1] == '8' ||
                    game.turn() == 'b' && target[1] == '1') {
                
                    // handle promotion
                    promotion = prompt("Promote to (q,r,b,n):", "q")
                    if (promotion === null || !['q','r','b','n'].includes(promotion.toLowerCase())) {
                        promotion = 'q' // default to queen
                    } else {
                        promotion = promotion.toLowerCase()
                    }
                }
                let move = game.move({
                    from: source,
                    to: target,
                    promotion: promotion
                })

                // illegal move
                if (move === null) return 'snapback'

        }

        function onMouseoverSquare (square, piece) {
            // get list of possible moves for this square
            let moves = game.moves({
                square: square,
                verbose: true
            })

            // exit if there are no moves available for this square
            if (moves.length === 0) return

            // highlight the square they moused over
            greySquare(square)

            // highlight the possible squares for this piece
            for (let i = 0; i < moves.length; i++) {
                greySquare(moves[i].to)
            }
            }

        function onMouseoutSquare (square, piece) {
            removeGreySquares()
        }

        function onSnapEnd () {
            board.position(game.fen())
        }

        function onChange (obj) {
            $fen.html(game.fen())
            $pgn.html(game.pgn())

            if (game.game_over()) {
                let result = game.in_checkmate() ? 'Checkmate' : 'Draw'
                $status.html(`Game Over: <b>${result}</b>`)

                return true;
            }

            if ($('#player-black').val() === "Computer" && game.turn() === 'b' ||
                $('#player-white').val() === "Computer" && game.turn() === 'w'){
                getComputerMove(game.turn(), depth)

            }
        }

        function onChangeSelector (color) {
            if (color === "black") {
                if ($('#player-black').val() === "Computer") {
                    if (game.turn() === 'b') {
                        getComputerMove(game.turn(), depth)
                    }
                } else {
                    
                }
            } else {
                if ($('#player-white').val() === "Computer") {
                    if (game.turn() === 'w') {
                        getComputerMove(game.turn(), depth)
                    }
                } else {
                    
                }
            }
        }

        function getComputerMove(color, depth) {
            let moves = game.history({verbose: true}).map(move => {
                let uci = move.from + move.to;
                
                // Add promotion character if it exists (e.g., "q")
                if (move.promotion) {
                    uci += move.promotion;
                }
                return uci;
            });

            fetch('/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({moves: moves, color: color, depth: depth})
            }).then((response) => {
                return response.json()
            
            }).then((data) => {
                console.log(data)
                console.log("Best move: " + data.move + " Eval: " + data.evaluation)
                let move = game.move(data.move)
                if (!(move === null)) {
                    board.position(game.fen())
                }
                
                $evalBar.style.height = data.evaluation.parseInt()
            })
        }

        function onDepthChange(slider) {
            document.getElementById('depthTitle').innerText = 'Depth: ' + slider.value
            depth = parseInt(slider.value) 
     }

        let config = {
            draggable: true,
            position: 'start',
            pieceTheme:"assets/{piece}.png",
            onDragStart: onDragStart,
            onDrop: onDrop,
            onMouseoutSquare: onMouseoutSquare,
            onMouseoverSquare: onMouseoverSquare,
            onSnapEnd: onSnapEnd,
            onChange: onChange
        }
        board = Chessboard('myBoard', config)
    </script>
</body>
</html>