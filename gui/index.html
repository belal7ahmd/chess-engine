<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Chess Board</title>
    <!--for Styling-->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <!-- 2. jQuery (Requirement) -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- 3. The chessboard.js library -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
</head>
<body>
    <div id="board-container">
        <span id="eval-bar"></span>
        <div id="myBoard" style="width: 400px"></div>
        <div id="selectors">
            <select id="player-black" class="selector">
                <option value="Player">Player</option>
                <option value="Computer">Computer</option>
            </select>
            <select id="player-white" class="selector">
                <option value="Player">Player</option>
                <option value="Computer">Computer</option>
            </select>
        </div>
    </div>
    
    <label>Status:</label>
    <div id="status"></div>
    <label>FEN:</label>
    <div id="fen"></div>
    <label>PGN:</label>
    <div id="pgn"></div>


    <style>
        #board-container {
            display: flex;
            align-items: center;
        }
        #eval-bar {
            width: 20px;
            height: 400px;
            border: 1px solid black;
            margin-right: 10px;
            background: linear-gradient(to top, black 50%, white 50%);
        }
        #selectors {
            margin-left: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .selector {
            margin-bottom: 50px;
            margin-top: 50px;

        }
    </style>

    <script>
        // NOTE: this example uses the chess.js library:
        // https://github.com/jhlywa/chess.js

        var board = null
        var game = new Chess()
        var $status = $('#status')
        var $fen = $('#fen')
        var $pgn = $('#pgn')
        var whiteSquareGrey = '#a9a9a9'
        var blackSquareGrey = '#696969'

        function removeGreySquares () {
            $('#myBoard .square-55d63').css('background', '')
        }

        function greySquare (square) {
            var $square = $('#myBoard .square-' + square)

            var background = whiteSquareGrey
            if ($square.hasClass('black-3c85d')) {
                background = blackSquareGrey
            }

            $square.css('background', background)
        }

        function onDragStart (source, piece) {
            // do not pick up pieces if the game is over
            if (game.game_over()) return false

            // or if it's not that side's turn
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false
            }

            if (piece.search(/^b/) !== -1 && $('#player-black').val() === "Computer"
                || piece.search(/^w/) !== -1 && $('#player-white').val() === "Computer") {
                return false
            }
        }

        function onDrop (source, target) {
                removeGreySquares()

                // see if the move is legal
                var move = game.move({
                    from: source,
                    to: target,
                    promotion: 'q' // NOTE: always promote to a queen for example simplicity
                })

                // illegal move
                if (move === null) return 'snapback'


                if ($('#player-black').val() === "Computer" && game.turn() === 'b' ||
                    $('#player-white').val() === "Computer" && game.turn() === 'w'){
                        fetch('/move', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({fen: game.fen(), move: move.san, color: game.turn(), depth: 5})
                    }).then((response) => {
                        return response.text()
                    }).then((data) => {
                        evaluation, best_move = data.split(' ')
                        console.log("Best move: " + best_move + " Eval: " + evaluation)
                        game.move(best_move)
                        board.position(game.fen())
                    })
                    }

        }

        function onMouseoverSquare (square, piece) {
            // get list of possible moves for this square
            var moves = game.moves({
                square: square,
                verbose: true
            })

            // exit if there are no moves available for this square
            if (moves.length === 0) return

            // highlight the square they moused over
            greySquare(square)

            // highlight the possible squares for this piece
            for (var i = 0; i < moves.length; i++) {
                greySquare(moves[i].to)
            }
            }

        function onMouseoutSquare (square, piece) {
            removeGreySquares()
        }

        function onSnapEnd () {
            board.position(game.fen())
        }

        var config = {
            draggable: true,
            position: 'start',
            pieceTheme:"assets/{piece}.png",
            onDragStart: onDragStart,
            onDrop: onDrop,
            onMouseoutSquare: onMouseoutSquare,
            onMouseoverSquare: onMouseoverSquare,
            onSnapEnd: onSnapEnd
        }
        board = Chessboard('myBoard', config)
    </script>
</body>
</html>